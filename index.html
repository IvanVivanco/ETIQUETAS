<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Deteco DTX 5.0</title>
    
    <!-- LIBRERIAS EXTERNAS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --ios-bg: #F5F5F7;
            --primary-color: #F26522; /* Naranja Deteco */
            --primary-light: #FFF7ED; /* Naranja muy suave para fondos */
            --primary-hover: #d14d10; /* Naranja Oscuro para Hover */
            --page-width: 210mm;
            --page-height: 297mm;
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--ios-bg); color: #1d1d1f; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

        /* --- UI PRINCIPAL --- */
        .app-header { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border-bottom: 1px solid #e5e5e5; height: 60px; padding: 0 24px; display: flex; justify-content: space-between; align-items: center; z-index: 50; }
        .app-title { font-weight: 800; font-size: 1.1rem; color: #000; letter-spacing: -0.5px; }
        
        .ios-btn { padding: 8px 16px; border-radius: 8px; font-size: 0.85rem; font-weight: 600; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px; cursor: pointer; border: none; }
        
        /* BOTONES DE PESTAÑAS (MODIFICADO) */
        .btn-ghost { background: transparent; color: #86868b; }
        .btn-ghost:hover { background: #f5f5f7; color: #1d1d1f; }
        
        .btn-active-tab { 
            background: var(--primary-light); /* Fondo Naranja Suave */
            color: var(--primary-color);      /* Texto Naranja Corporativo */
            font-weight: 700; 
            border: 1px solid rgba(242, 101, 34, 0.1); /* Borde sutil */
        }

        .btn-primary { background: #000; color: white; }
        .btn-primary:hover { background: #333; }
        .btn-secondary { background: #e5e5e5; color: #000; }

        /* --- LAYOUT & SETTINGS --- */
        .main-layout { display: flex; flex: 1; overflow: hidden; }
        .settings-panel { width: 340px; background: #fff; border-right: 1px solid #e5e5e5; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 24px; flex-shrink: 0; }
        
        .control-group { display: flex; flex-direction: column; gap: 12px; }
        .group-label { font-size: 0.75rem; font-weight: 600; text-transform: uppercase; color: #86868b; letter-spacing: 0.5px; }
        
        .input-row { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
        .ios-input { background: #f5f5f7; border: 1px solid transparent; border-radius: 8px; padding: 8px 12px; font-size: 0.9rem; width: 100%; transition: 0.2s; text-align: right; }
        .ios-input:focus { background: #fff; border-color: var(--primary-color); outline: none; }
        
        /* Sliders */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: var(--primary-color); cursor: pointer; margin-top: -6px; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #e5e5e5; border-radius: 2px; }

        /* --- PREVIEW AREA --- */
        .preview-panel { flex: 1; background: #e9e9eb; padding: 40px; overflow-y: auto; display: flex; flex-direction: column; align-items: center; }
        .page { 
            background: white; 
            width: var(--page-width); 
            height: var(--page-height); 
            padding: 10mm; 
            margin-bottom: 30px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
            display: grid; 
            box-sizing: border-box; 
            position: relative; 
            transition: width 0.3s, height 0.3s; 
        }
        
        /* --- ETIQUETA --- */
        .label-card { 
            border: 1px solid #d1d5db; 
            border-radius: 6px; 
            background: white; 
            display: flex; 
            flex-direction: row; 
            overflow: hidden;
            position: relative;
        }

        .strip-orange { width: 14px; background-color: var(--primary-color); height: 100%; flex-shrink: 0; }

        /* COLUMNA IZQUIERDA */
        .left-col {
            flex: 1;
            padding: 18px 14px; 
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .header-block {
            display: flex;
            flex-direction: column;
            gap: 4px; 
            margin-bottom: 8px; 
        }

        .product-name {
            font-weight: 800;
            color: #111827;
            text-transform: uppercase;
            line-height: 1.1;
            width: 100%;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2; 
            -webkit-box-orient: vertical;
        }

        .product-sku-row {
            display: flex;
            align-items: baseline;
            gap: 6px;
        }
        .sku-label { font-size: 0.65rem; color: #6b7280; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .sku-value { font-weight: 700; color: #374151; }

        .organizer-block { 
            flex: 1;
            display: flex; 
            align-items: center; 
            justify-content: flex-start; 
            padding: 4px 0;
        }

        .organizer-number { 
            font-weight: 900; 
            color: #000; 
            line-height: 1; 
            letter-spacing: -1px; 
        }
        
        .product-family {
            font-weight: 600;
            color: #4b5563;
            text-transform: uppercase;
            padding-top: 8px; 
            border-top: 1px solid transparent;
        }

        /* COLUMNA DERECHA */
        .right-col {
            width: 35%;
            border-left: 1px solid #f3f4f6;
            display: flex;
            flex-direction: column;
            padding: 6px;
        }

        .qr-container {
            flex: 1;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2px;
            overflow: hidden;
        }

        .qr-container img, .qr-container canvas {
            width: 100% !important;
            height: 100% !important;
            object-fit: contain;
        }

        .logo-container {
            height: 24px;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 2px;
            margin-top: 6px;
        }
        .logo-container img { max-width: 90%; max-height: 100%; object-fit: contain; }

        /* --- VISOR --- */
        #view-visor { background: #fff; flex: 1; padding: 20px; display: none; justify-content: center; align-items: flex-start; overflow-y: auto; }
        .visor-box { max-width: 600px; width: 100%; margin-top: 20px; }
        .search-container { display: flex; gap: 10px; margin-bottom: 30px; }
        .search-input { flex: 1; padding: 15px; border: 2px solid #e5e5e5; border-radius: 12px; font-size: 1.1rem; outline: none; transition: 0.2s; }
        .search-input:focus { border-color: var(--primary-color); }
        .search-btn { background: var(--primary-color); color: white; border: none; padding: 0 25px; border-radius: 12px; font-weight: 700; cursor: pointer; }
        
        /* BOTON FICHA TÉCNICA */
        .btn-datasheet { 
            display: inline-flex; align-items: center; justify-content: center; width: 100%; 
            background-color: var(--primary-color); 
            color: white; font-weight: 700; padding: 16px; border-radius: 12px; font-size: 1rem; 
            margin-top: 20px; text-decoration: none; transition: background 0.2s; 
            box-shadow: 0 4px 10px rgba(242, 101, 34, 0.3); 
        }
        .btn-datasheet:hover { background-color: var(--primary-hover); transform: translateY(-1px); }

        .hidden { display: none !important; }
        @media print {
            .app-header, .settings-panel, .no-print { display: none !important; }
            .preview-panel { padding: 0; background: white; overflow: visible; height: auto; }
            .page { box-shadow: none; margin: 0; break-after: page; }
            #view-visor { display: none; }
            @page { margin: 0; }
        }
    </style>
</head>
<body>

    <!-- HEADER -->
    <div class="app-header no-print">
        <div class="flex items-center gap-4">
            <!-- NOMBRE CAMBIADO A DTX -->
            <div class="app-title">Deteco <span class="text-orange-600">DTX</span></div>
            
            <!-- PESTAÑAS CON COLOR CORPORATIVO -->
            <div class="flex bg-gray-100 p-1 rounded-lg">
                <button onclick="setView('generator')" id="btn-gen" class="ios-btn btn-active-tab">Generador</button>
                <button onclick="setView('visor')" id="btn-vis" class="ios-btn btn-ghost">Visor</button>
            </div>
        </div>
        <div class="flex gap-2">
            <button onclick="downloadPDF()" class="ios-btn btn-secondary"><i class="fa-regular fa-file-pdf mr-1"></i> PDF</button>
            <button onclick="window.print()" class="ios-btn btn-primary"><i class="fa-solid fa-print mr-1"></i> Imprimir</button>
        </div>
    </div>

    <div class="main-layout">
        <!-- PANEL IZQUIERDO -->
        <div class="settings-panel no-print" id="panel-settings">
            
            <!-- BUSCADOR -->
            <div class="control-group">
                <div class="group-label">Base de Datos</div>
                <div class="relative">
                    <i class="fa-solid fa-search absolute left-3 top-2.5 text-gray-400 text-xs"></i>
                    <input type="text" id="dbSearch" placeholder="Buscar producto..." class="ios-input pl-8 text-left bg-white border-gray-200">
                    <div id="searchResults" class="hidden absolute top-full left-0 w-full bg-white shadow-xl border border-gray-100 rounded-lg mt-1 z-50 max-h-48 overflow-y-auto"></div>
                </div>
                <div id="dbStatus" class="text-[10px] text-gray-400 text-right">Conectando...</div>
            </div>

            <!-- CONTROLES DE TAMAÑO -->
            <div class="control-group bg-gray-50 p-3 rounded-lg border border-gray-100">
                <div class="group-label text-orange-600 mb-2">Ajuste de Tamaños</div>
                <div class="flex flex-col gap-3">
                    <div>
                        <div class="flex justify-between text-xs mb-1"><span>Nombre Producto</span> <span id="valSizeName" class="font-bold">20px</span></div>
                        <input type="range" id="sizeName" min="10" max="60" value="20" step="1">
                    </div>
                    <div>
                        <div class="flex justify-between text-xs mb-1"><span>Cód. Producto (Peq)</span> <span id="valSizeSku" class="font-bold">12px</span></div>
                        <input type="range" id="sizeSku" min="8" max="24" value="12" step="1">
                    </div>
                    <div>
                        <div class="flex justify-between text-xs mb-1"><span>Organizador (Gde)</span> <span id="valSizeOrg" class="font-bold">40px</span></div>
                        <input type="range" id="sizeOrg" min="20" max="120" value="40" step="1">
                    </div>
                    <div>
                        <div class="flex justify-between text-xs mb-1"><span>Familia</span> <span id="valSizeFamily" class="font-bold">10px</span></div>
                        <input type="range" id="sizeFamily" min="8" max="30" value="10" step="1">
                    </div>
                </div>
            </div>

            <!-- CONTENIDO ETIQUETA -->
            <div class="control-group">
                <div class="group-label">Datos Producto</div>
                <div class="input-row">
                    <span class="text-xs font-medium w-20">Cód. Prod.</span>
                    <input type="text" id="productCodeInput" value="C-01-05" class="ios-input">
                </div>
                <div class="input-row">
                    <span class="text-xs font-medium w-20">Nombre</span>
                    <input type="text" id="nameInput" value="GUANTES MULTIFLEX" class="ios-input">
                </div>
                <div class="input-row">
                    <span class="text-xs font-medium w-20">Familia</span>
                    <input type="text" id="familyInput" value="EPP" class="ios-input">
                </div>
            </div>

            <!-- SECUENCIA ORGANIZADOR -->
            <div class="control-group">
                <div class="group-label">Secuencia Organizador</div>
                <div class="input-row">
                    <span class="text-xs font-medium w-20">Prefijo</span>
                    <input type="text" id="prefixInput" placeholder="(Opcional)" class="ios-input w-20">
                </div>
                <div class="input-row">
                    <span class="text-xs font-medium w-20">Inicio N°</span>
                    <input type="number" id="startInput" value="179" class="ios-input font-bold text-lg w-20">
                    <label class="flex items-center gap-2 cursor-pointer ml-2">
                        <input type="checkbox" id="checkNumbering" checked class="w-4 h-4 accent-orange-500">
                        <span class="text-xs">Auto</span>
                    </label>
                </div>
            </div>

            <!-- DISEÑO DE HOJA -->
            <div class="control-group">
                <div class="group-label">Diseño de Hoja</div>
                <div class="input-row mb-2">
                    <span class="text-xs font-medium">Orientación</span>
                    <select id="orientationInput" class="ios-input bg-white cursor-pointer w-32">
                        <option value="portrait">Vertical</option>
                        <option value="landscape">Horizontal</option>
                    </select>
                </div>
                <div class="grid grid-cols-3 gap-2">
                    <input type="number" id="qtyInput" value="20" class="ios-input text-center" title="Total">
                    <input type="number" id="rowsInput" value="5" class="ios-input text-center" title="Filas">
                    <input type="number" id="colsInput" value="4" class="ios-input text-center" title="Columnas">
                </div>
            </div>
            
            <div class="mt-auto pt-4 border-t border-gray-100 text-center">
                 <button onclick="location.reload()" class="text-xs text-red-400 hover:text-red-600">Reiniciar App</button>
            </div>
        </div>

        <!-- VISTA: GENERADOR -->
        <div class="preview-panel" id="view-generator">
            <div id="pages-wrapper"></div>
        </div>

        <!-- VISTA: VISOR MANUAL -->
        <div id="view-visor">
            <div class="visor-box">
                <div class="text-center mb-8">
                    <h2 class="text-3xl font-black text-gray-900 mb-2">Visor de Inventario</h2>
                    <p class="text-gray-500">Ingresa el CÓDIGO DEL PRODUCTO para ver detalles</p>
                </div>

                <div class="search-container">
                    <input type="text" id="manualInput" placeholder="Ej: C-01-05" class="search-input" onkeypress="handleEnter(event)">
                    <button onclick="manualSearch()" class="search-btn"><i class="fa-solid fa-search"></i></button>
                </div>
                
                <div id="scanResult" class="hidden bg-white p-8 pb-4 rounded-2xl border border-gray-100 shadow-xl text-center relative">
                    <!-- LOGO CORPORATIVO CON AJUSTE PC -->
                    <img src="Logo DETECO_2_page-0001.jpg" 
                         class="absolute top-4 left-4 w-24 sm:w-32 md:w-48 lg:w-60 h-auto object-contain opacity-90 transition-all duration-300" 
                         onerror="this.style.display='none'">

                    <div class="text-xs font-bold text-orange-500 uppercase tracking-widest mb-1 mt-2">Resultado</div>
                    <div id="resCode" class="text-4xl font-black text-gray-900 mb-2 tracking-tight">CODE</div>
                    <div id="resName" class="text-xl text-gray-600 mb-6 font-medium">Nombre del producto</div>
                    
                    <div class="grid grid-cols-2 gap-6 border-t border-b border-gray-100 py-6 mb-4">
                        <div><div class="text-xs text-gray-400 uppercase font-bold tracking-wider mb-1">Stock</div><div id="resStock" class="text-3xl font-black text-green-600">0</div></div>
                        <div><div class="text-xs text-gray-400 uppercase font-bold tracking-wider mb-1">ORGANIZADOR</div><div id="resLoc" class="text-3xl font-bold text-gray-800">-</div></div>
                    </div>
                    
                    <div id="datasheetArea" class="hidden">
                        <a id="btnDatasheet" href="#" target="_blank" class="btn-datasheet"><i class="fa-solid fa-file-pdf mr-2"></i> Descargar Ficha Técnica</a>
                        <p class="text-xs text-gray-400 mt-2 mb-4">Se abrirá en una nueva pestaña</p>
                    </div>
                    <div id="noDataArea" class="hidden mt-4 mb-4 text-gray-400 text-sm">No hay ficha técnica disponible.</div>

                    <!-- CRÉDITOS (PARTE INFERIOR) -->
                    <div class="border-t border-gray-100 pt-3 mt-2">
                        <p class="text-[10px] text-gray-300 font-medium">Programado y Creado por Iván Vivanco</p>
                    </div>
                </div>

                <div id="scanError" class="hidden bg-red-50 text-red-600 p-4 rounded-xl text-center mt-4 border border-red-100 font-medium">
                    <i class="fa-solid fa-circle-exclamation mr-2"></i> Producto no encontrado.
                </div>
            </div>
        </div>
    </div>

    <!-- LOGICA -->
    <script>
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSM3lTLNPOgrglxy22q_iVTguBWEsuuTVfpHQGXMkItgOXKa04h69EfRqQArlgVR7ZvUB-QfpMXjoGr/pub?output=csv';
        let dbProducts = [];

        const els = {
            wrapper: document.getElementById('pages-wrapper'),
            qty: document.getElementById('qtyInput'), rows: document.getElementById('rowsInput'), cols: document.getElementById('colsInput'),
            prefix: document.getElementById('prefixInput'), start: document.getElementById('startInput'), checkNum: document.getElementById('checkNumbering'),
            productCode: document.getElementById('productCodeInput'), name: document.getElementById('nameInput'), family: document.getElementById('familyInput'),
            orientation: document.getElementById('orientationInput'),
            dbSearch: document.getElementById('dbSearch'), searchResults: document.getElementById('searchResults'),
            sizeName: document.getElementById('sizeName'), sizeSku: document.getElementById('sizeSku'), sizeOrg: document.getElementById('sizeOrg'), sizeFamily: document.getElementById('sizeFamily'),
            valSizeName: document.getElementById('valSizeName'), valSizeSku: document.getElementById('valSizeSku'), valSizeOrg: document.getElementById('valSizeOrg'), valSizeFamily: document.getElementById('valSizeFamily')
        };

        window.addEventListener('load', async () => {
            await loadDB();
            const urlParams = new URLSearchParams(window.location.search);
            const searchId = urlParams.get('id');
            if (searchId) {
                setView('visor');
                document.getElementById('manualInput').value = searchId;
                manualSearch(searchId);
            } else {
                renderLabels();
            }
        });

        async function loadDB() {
            try {
                const res = await fetch(CSV_URL);
                const text = await res.text();
                const rows = text.split('\n').map(r => r.split(','));
                const headers = rows[0].map(h => h.trim().toUpperCase().replace(/"/g,''));
                dbProducts = rows.slice(1).map(r => {
                    let obj = {};
                    r.forEach((val, i) => { if(headers[i]) obj[headers[i]] = val.replace(/"/g,'').trim(); });
                    return obj;
                }).filter(p => p.CODIGO);
                document.getElementById('dbStatus').innerText = `Online: ${dbProducts.length} productos`;
                document.getElementById('dbStatus').className = "text-[10px] text-green-600 text-right font-bold";
            } catch (e) {
                console.error(e);
                document.getElementById('dbStatus').innerText = "Sin conexión a Excel";
            }
        }

        function handleEnter(e) { if(e.key === 'Enter') manualSearch(); }

        function manualSearch(codeOverride) {
            const rawInput = codeOverride || document.getElementById('manualInput').value;
            if(!rawInput) return;
            const searchCode = rawInput.trim().toUpperCase();
            let prod = dbProducts.find(p => p.CODIGO.toUpperCase() === searchCode);
            if (!prod) prod = dbProducts.find(p => p.CODIGO.toUpperCase().includes(searchCode));

            const resDiv = document.getElementById('scanResult');
            const errDiv = document.getElementById('scanError');
            const datasDiv = document.getElementById('datasheetArea');
            const btnData = document.getElementById('btnDatasheet');
            const noDataDiv = document.getElementById('noDataArea');

            if(prod) {
                errDiv.classList.add('hidden');
                resDiv.classList.remove('hidden');
                document.getElementById('resCode').innerText = prod.CODIGO;
                document.getElementById('resName').innerText = prod.NOMBRE;
                document.getElementById('resStock').innerText = prod.STOCK || 0;
                document.getElementById('resLoc').innerText = prod.ORGANIZADOR || prod.UBICACION || '-';
                if(prod.FICHA && prod.FICHA.length > 5) {
                    datasDiv.classList.remove('hidden'); noDataDiv.classList.add('hidden'); btnData.href = prod.FICHA;
                } else {
                    datasDiv.classList.add('hidden'); noDataDiv.classList.remove('hidden');
                }
            } else {
                resDiv.classList.add('hidden'); errDiv.classList.remove('hidden');
            }
        }

        function renderLabels() {
            els.wrapper.innerHTML = '';
            const qty = parseInt(els.qty.value) || 0;
            const rows = parseInt(els.rows.value) || 5;
            const cols = parseInt(els.cols.value) || 4;
            const start = parseInt(els.start.value) || 1;
            const orientation = els.orientation.value;
            
            const sName = els.sizeName.value + 'px';
            const sSku = els.sizeSku.value + 'px';
            const sOrg = els.sizeOrg.value + 'px';
            const sFamily = els.sizeFamily.value + 'px';
            
            els.valSizeName.innerText = sName;
            els.valSizeSku.innerText = sSku;
            els.valSizeOrg.innerText = sOrg;
            els.valSizeFamily.innerText = sFamily;

            if(orientation === 'landscape') {
                document.documentElement.style.setProperty('--page-width', '297mm');
                document.documentElement.style.setProperty('--page-height', '210mm');
            } else {
                document.documentElement.style.setProperty('--page-width', '210mm');
                document.documentElement.style.setProperty('--page-height', '297mm');
            }
            
            const perPage = rows * cols;
            const pages = Math.ceil(qty / perPage);
            let count = 0;
            const baseUrl = window.location.href.split('?')[0];

            for(let p=0; p<pages; p++) {
                const page = document.createElement('div'); page.className = 'page';
                page.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
                page.style.gridTemplateRows = `repeat(${rows}, 1fr)`;
                page.style.gap = '8px';

                const itemsHere = Math.min(perPage, qty - count);
                for(let i=0; i<itemsHere; i++) {
                    const current = start + count;
                    count++;
                    
                    let prefix = els.prefix.value;
                    let orgNum = prefix ? `${prefix}${current}` : `${current}`;
                    if(!els.checkNum.checked) orgNum = prefix ? prefix : String(start);

                    const productCode = els.productCode.value;
                    const smartLink = `${baseUrl}?id=${productCode}`;
                    const qrId = `qr-code-${count}`;

                    const card = document.createElement('div');
                    card.className = 'label-card';
                    card.innerHTML = `
                        <div class="strip-orange"></div>
                        <div class="left-col">
                            <div class="header-block">
                                <div class="product-name" style="font-size:${sName}">${els.name.value}</div>
                                <div class="product-sku-row">
                                    <span class="sku-label">CÓDIGO:</span>
                                    <span class="sku-value" style="font-size:${sSku}">${productCode}</span>
                                </div>
                            </div>
                            
                            <div class="organizer-block">
                                <span class="organizer-number" style="font-size:${sOrg}">${orgNum}</span>
                            </div>
                            
                            <div class="product-family" style="font-size:${sFamily}">${els.family.value}</div>
                        </div>
                        <div class="right-col">
                            <div class="qr-container" id="${qrId}"></div>
                            <div class="logo-container"><img src="logo (2).png" onerror="this.style.display='none'"></div>
                        </div>
                    `;
                    page.appendChild(card);
                    new QRCode(card.querySelector(`#${qrId}`), { text: smartLink, width: 300, height: 300, correctLevel: QRCode.CorrectLevel.H });
                }
                els.wrapper.appendChild(page);
            }
        }

        function setView(view) {
            document.getElementById('view-generator').style.display = view === 'generator' ? 'flex' : 'none';
            document.getElementById('view-visor').style.display = view === 'visor' ? 'flex' : 'none';
            document.getElementById('panel-settings').style.display = view === 'generator' ? 'flex' : 'none';
            document.getElementById('btn-gen').className = view === 'generator' ? 'ios-btn btn-active-tab' : 'ios-btn btn-ghost';
            document.getElementById('btn-vis').className = view === 'visor' ? 'ios-btn btn-active-tab' : 'ios-btn btn-ghost';
        }

        els.dbSearch.addEventListener('input', (e) => {
            const val = e.target.value.toLowerCase();
            if(val.length < 2) { els.searchResults.classList.add('hidden'); return; }
            const matches = dbProducts.filter(p => (p.CODIGO && p.CODIGO.toLowerCase().includes(val)) || (p.NOMBRE && p.NOMBRE.toLowerCase().includes(val))).slice(0, 5);
            els.searchResults.innerHTML = '';
            if(matches.length) {
                els.searchResults.classList.remove('hidden');
                matches.forEach(p => {
                    const div = document.createElement('div');
                    div.className = "p-3 hover:bg-orange-50 cursor-pointer border-b text-sm flex justify-between";
                    div.innerHTML = `<span><strong>${p.CODIGO}</strong></span> <span class="text-gray-500 truncate ml-2 text-xs">${p.NOMBRE}</span>`;
                    div.onclick = () => {
                        els.productCode.value = p.CODIGO; els.name.value = p.NOMBRE; els.family.value = p.CATEGORIA || '';
                        els.searchResults.classList.add('hidden'); els.dbSearch.value = '';
                        renderLabels();
                    };
                    els.searchResults.appendChild(div);
                });
            } else { els.searchResults.classList.add('hidden'); }
        });

        function downloadPDF() {
            const el = els.wrapper;
            const orient = els.orientation.value === 'landscape' ? 'l' : 'p';
            const opt = { margin:0, filename:'etiquetas_deteco.pdf', image:{type:'jpeg',quality:0.98}, html2canvas:{scale:2}, jsPDF:{unit:'mm',format:'a4', orientation: orient} };
            html2pdf().set(opt).from(el).save();
        }

        let timeout;
        [els.qty, els.rows, els.cols, els.prefix, els.start, els.name, els.family, els.checkNum, els.productCode, els.orientation, els.sizeName, els.sizeSku, els.sizeOrg, els.sizeFamily].forEach(el => {
            el.addEventListener('input', () => { clearTimeout(timeout); timeout = setTimeout(renderLabels, 150); });
        });
    </script>
</body>
</html>
